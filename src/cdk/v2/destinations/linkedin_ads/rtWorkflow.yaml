bindings:
  - path: ./utils
  - path: ./config

steps:
  - name: validateInput
    template: |
      $.assert(Array.isArray(^) && ^.length > 0, "Invalid event array")

  - name: transform
    externalWorkflow:
      path: ./procWorkflow.yaml
      bindings:
        - name: batchMode
          value: true
    loopOverInput: true
  - name: successfulEvents
    template: |
      $.outputs.transform#idx.output.({
        "message": .[],
        "destination": ^ [idx].destination,
        "metadata": ^ [idx].metadata
      })[]
  - name: failedEvents
    template: |
      $.outputs.transform#idx.error.({
        "metadata": ^[idx].metadata[],
        "destination": ^[idx].destination,
        "batched": false,
        "statusCode": .status,
        "error": .message,
        "statTags": .originalError.statTags
      })[]

  - name: batchSuccessfulEvents
    description: Batches the successfulEvents
    template: |
      $.batchResponseBuilder($.outputs.successfulEvents);

  - name: finalPayload
    template: |
      [...$.outputs.failedEvents, ...$.outputs.batchSuccessfulEvents]

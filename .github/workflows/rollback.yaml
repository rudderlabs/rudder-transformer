name: Rollback Transformer to another version

on:
  workflow_dispatch:

jobs:
  rollback-and-create-pr:
    name: Rollback Production To a Tag
    runs-on: ubuntu-latest

    # Only allow to be deployed from tags and main
    # Only allow specific actors to trigger
    if: (startsWith(github.ref, 'refs/tags/') || startsWith(github.ref, 'refs/heads/main')) && (github.actor == 'ItsSudip' || github.actor == 'krishna2020' || github.actor == 'saikumarrs') && (github.triggering_actor == 'ItsSudip' || github.triggering_actor == 'krishna2020' || github.triggering_actor == 'saikumarrs')

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Display Current Package Version
        run: |
          TAG=${{ github.ref_name }}
          VERSION=${TAG#v}
          echo $VERSION

      - name: Clone repository and raise pull request
        run: |
          TAG=${{ github.ref_name }}
          VERSION=${TAG#v}
          git clone https://${{secrets.PAT}}@github.com/rudderlabs/rudder-devops.git
          git config --global user.email "noreply@github.com"
          git config --global user.name "GitHub Actions"
          git checkout -b "shared-transformer-$VERSION"
          cd rudder-devops/helm-charts/shared-services
          yq eval -i ".rudder-transformer.image.tag=\"$VERSION\"" values.prod.yaml
          git add values.prod.yaml
          cd per-az
          yq eval -i ".rudder-transformer.image.tag=\"$VERSION\"" values.blue-release.yaml
          yq eval -i ".user-transformer.image.tag=\"$VERSION\"" values.blue-release.yaml
          git add values.blue-release.yaml
          cd ../../config-be-rudder-transformer
          yq eval -i ".config-be-rudder-transformer.image.tag=\"$VERSION\"" values.prod.yaml
          yq eval -i ".config-be-user-transformer.image.tag=\"$VERSION\"" values.prod.yaml
          git add values.prod.yaml
          git commit -m "changing version for shared transformer"
          git push -u origin "shared-transformer-$VERSION"
          hub pull-request -m "rudder-transformer version change-$VERSION

bindings:
  - name: EventType
    path: ../../../../constants
  - path: ../../bindings/jsontemplate
    exportAll: true
  - name: removeUndefinedAndNullValues
    path: ../../../../v0/util
  - name: defaultRequestConfig
    path: ../../../../v0/util

steps:
  - name: messageType
    template: |
      .message.type.toLowerCase();

  - name: validateInput
    template: |
      $.assert(.message.type, "message Type is not present. Aborting message.");
      $.assert(.message.type in {{$.EventType.([.TRACK, .IDENTIFY])}}, 
        "message type " + .message.type + " is not supported");

  - name: validateIdentifyEmail
    condition: $.outputs.messageType === {{$.EventType.IDENTIFY}}
    template: |
      const email = .message.({{{{$.getGenericPaths("emailOnly")}}}});
      $.assert(email, "email is required. Aborting");

  - name: validateTrackIdentifier
    condition: $.outputs.messageType === {{$.EventType.TRACK}}
    template: |
      const userId = .message.({{{{$.getGenericPaths("userIdOnly")}}}});
      const email = .message.({{{{$.getGenericPaths("emailOnly")}}}});
      $.assert(email || userId, "Either email or userId is required. Aborting");

  - name: validateEventName
    condition: $.outputs.messageType === {{$.EventType.TRACK}}
    template: |
      $.assert(.message.event, "event is required for track call")

  - name: prepareContext
    template: |
      $.context.messageType = .message.type.toLowerCase();
      $.context.payload = {};

  - name: identifyPayload
    condition: $.outputs.messageType === {{$.EventType.IDENTIFY}}
    template: |
      $.context.endpoint = "https://app.loops.so/api/v1/contacts/update";
      const payload = {}
      Object.assign(payload, .message.context.traits);
      payload.userId = .message.userId;
      $.context.payload = payload;

  - name: trackPayload
    condition: $.outputs.messageType === {{$.EventType.TRACK}}
    template: |
      $.context.endpoint = "https://app.loops.so/api/v1/events/send";
      const payload = {}
      Object.assign(payload, .message.context.traits);
      payload.userId = .message.userId;
      payload.eventName = .message.event;
      payload.eventProperties = .message.properties;
      $.context.payload = payload;

  - name: buildResponse
    template: |
      const response = $.defaultRequestConfig();
      response.body.JSON = $.context.payload;
      response.endpoint = $.context.endpoint;
      response.headers = {
        "authorization": "Bearer " + .destination.Config.apiKey,
        "content-type": "application/json"
      };
      response

name: Prepare for Rollback in Production Environment

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate-actor:
    uses: ./.github/workflows/validate-actor.yml
    with:
      team_names: 'integrations'
    secrets:
      RELEASE_PRIVATE_KEY: ${{ secrets.RELEASE_PRIVATE_KEY }}

  create-rollback-pr:
    name: Update Helm Charts For Production and Create Pull Request
    runs-on: ubuntu-latest
    needs: validate-actor

    permissions:
      contents: read

    # Only allow to be deployed from tags and main branch
    if: (startsWith(github.ref, 'refs/tags/') || startsWith(github.ref, 'refs/heads/main'))

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        with:
          app-id: ${{ vars.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_PRIVATE_KEY }}
          permission-contents: write # to create commits and push branches
          permission-pull-requests: write # to create and update PRs
          repositories: rudder-devops,rudderstack-operator # to access cross-repo

      - name: Get Target Version
        id: target-version
        run: |
          version=${{ github.ref_name }}
          echo "tag_name=$version" >> $GITHUB_OUTPUT
          echo "Target Version: $tag_name"

      - name: Clone Devops Repo
        run: |
          git clone https://x-access-token:${{ steps.generate-token.outputs.token }}@github.com/rudderlabs/rudder-devops.git

      - name: Update Helm Charts and Raise Pull Request
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          cd rudder-devops
          git config user.name "GitHub Actions"
          git config user.email "noreply@github.com"
          git checkout -b shared-transformer-rollback-${{ steps.target-version.outputs.tag_name }}

          cd helm-charts/shared-services/per-az
          yq eval -i ".rudder-transformer.image.tag=\"${{ steps.target-version.outputs.tag_name }}\"" values.blue-release.yaml
          yq eval -i ".user-transformer.image.tag=\"${{ steps.target-version.outputs.tag_name }}\"" values.blue-release.yaml
          git add values.blue-release.yaml

          yq eval -i ".rudder-transformer.image.tag=\"${{ steps.target-version.outputs.tag_name }}\"" values.enterprise.yaml
          yq eval -i ".user-transformer.image.tag=\"${{ steps.target-version.outputs.tag_name }}\"" values.enterprise.yaml
          git add values.enterprise.yaml

          yq eval -i ".rudder-transformer.image.tag=\"${{ steps.target-version.outputs.tag_name }}\"" values.multi-tenant.yaml
          yq eval -i ".user-transformer.image.tag=\"${{ steps.target-version.outputs.tag_name }}\"" values.multi-tenant.yaml
          git add values.multi-tenant.yaml

          cd ../../config-be-rudder-transformer
          yq eval -i ".config-be-rudder-transformer.image.tag=\"${{ steps.target-version.outputs.tag_name }}\"" values.prod.yaml
          yq eval -i ".config-be-user-transformer.image.tag=\"${{ steps.target-version.outputs.tag_name }}\"" values.prod.yaml
          git add values.prod.yaml

          git commit -m "chore: rollback shared transformers to ${{ steps.target-version.outputs.tag_name }}"
          git push -u origin shared-transformer-rollback-${{ steps.target-version.outputs.tag_name }}

          gh pr create --fill

      - name: Update helm charts and raise pull request for enterprise customers on dedicated transformers
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          cd rudder-devops
          git config user.name "GitHub Actions"
          git config user.email "noreply@github.com"
          git checkout -b dedicated-transformer-rollback-${{ steps.target-version.outputs.tag_name }}

          cd customer-objects

          declare -a enabled_ut_customers=()
          declare -a sub_directories=('enterprise-us' 'enterprise-eu')

          # identify the customers enabled in sub-directories
          for directory in "${sub_directories[@]}"; do
            for f in "./$directory"/*; do
              [[ -f $f ]] || continue

              enabled="$(yq e '.spec.user_transformer.enabled' $f)"
              if [ $enabled == "true" ]; then
                  enabled_ut_customers+=( $f )
              fi
            done
          done

          if [ ${#enabled_ut_customers[@]} -gt 0 ]; then
            # bump up the customers version and repository information
            for customer in "${enabled_ut_customers[@]}"; do
                yq eval -i ".spec.user_transformer.image.version=\"${{ steps.target-version.outputs.tag_name }}\"" $customer
                git add $customer
            done

            git commit -m "chore: rollback dedicated transformers to ${{ steps.target-version.outputs.tag_name }}"
            git push -u origin dedicated-transformer-rollback-${{ steps.target-version.outputs.tag_name }}
            gh pr create --fill
          else
              echo "No dedicated customers found to rollback"
          fi

      - name: Clone Operator Repo
        run: |
          git clone https://x-access-token:${{ steps.generate-token.outputs.token }}@github.com/rudderlabs/rudderstack-operator.git

      - name: Update helm charts and raise pull request for dedicated transformer from operator
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          cd rudderstack-operator
          git config user.name "GitHub Actions"
          git config user.email "noreply@github.com"
          git checkout -b dedicated-transformer-rollback-${{ steps.target-version.outputs.tag_name }}

          cd operator-helm/valuefiles
          yq eval -i ".transformer.image.version=\"${{ steps.target-version.outputs.tag_name }}\"" values.yaml
          git add values.yaml

          git commit -m "chore: rollback dedicated transformer default version to ${{ steps.target-version.outputs.tag_name }}"
          git push -u origin dedicated-transformer-rollback-${{ steps.target-version.outputs.tag_name }}

          gh pr create --fill
